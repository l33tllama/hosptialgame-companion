<!doctype html>
<html>
<head>
  <title>Hospital Game Companion App</title>
  <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <link rel="stylesheet" href="bower_components/flipclock/src/flipclock/css/flipclock.css"/>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/flipclock/compiled/flipclock.min.js"></script>
  <script src="bower_components/howler.js/howler.min.js"></script>
  <script src="bower_components/jquery-Mustache/jquery.mustache.js"></script>
  <script src="bower_components/mustache.js/mustache.min.js"></script>
  <script src="bower_components/timer.js/dist/timer.min.js"></script>
</head>
<body>
  <div class="header">
    <h1><img id="logo" src="/res/img/lemmling-walrus.svg"/>
    Knotwurst Hospital Companion App</h1>
  </div>

  <!-- MENU SCREEN -->
  <div class="screen" id="menu-screen" state="active">
    <div class="main-content pure-u">
      <div class="menu-list">
        <ul class="button-list">
          <li class="button-list-item-custom">
            <span class="button-list-label">Number of Players:</span>
          </li>
          <li class="button-list-item-segmented pure-g">
            <span class="pure-u-1-3 button-1-3-wrapper">
              <a class="pure-button" id="player-dec">-</a>
            </span>
            <span class="pure-u-1-3 button-list-label" id="playerCount">1</span>
            <span class="pure-u-1-3 button-1-3-wrapper">
              <a class="pure-button pure-u-1-3" id="player-inc">+</a>
            </span>
            </li>
          <li class="button-list-item"><a class="pure-button" id="start-game" href="#">Start Game</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- WARMUP SCREEN -->
  <div class="screen" id="warmup-screen" state="inactive">
    <div class="main-content">
      <div class="menu-list">
        <div class="warmup-container pure-u">
          <h2 class="menu-heading">Warmup..</h2>
          <span class="pure-u-1-3"></span>
          <div class="flipclock pure-u-1-3"  id="warmup-flipclock"></div>
          <span class="pure-u-1-3"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- PLANNING PHASE SCREEN -->
  <div class="screen" id="planning-screen" state="inacive">
    <div class="main-content pure-u" id="planning-background">
      <div class="menu-list">
        <h2 class="menu-heading">Planning Phase</h2>
        <div class="clock-container pure-u">
          <span class="pure-u-1-3"></span>
          <div class="flipclock pure-u-1-3"  id="planning-flipclock"></div>
          <span class="pure-u-1-3"></span>
        </div>
        <ul class="button-list">
          <div class="event-list-container-container pure-g">
            <span class="pure-u-1-12"></span>
            <div class="pure-u-20-24 button-list-item-event-container" id="events-list">
            </div>
            <span class="pure-u-1-12"></span>
          </div>
          <ul class="button-list">
            <li class="button-list-item"><a class="pure-button" id="toggle-music" href="#">Toggle Music</a></li>
            <li class="button-list-item"><a class="pure-button" id="pause-game" href="#">Pause Game</a></li>
            <li class="button-list-item"><a class="pure-button" id="end-game" href="#">End Game</a></li>
          </ul>
        </ul>
      </div>
    </div>
  </div>
  <div class="screen" id="resolution-screen-1" state="inacive">
    <div class="main-content pure-u" id="planning-background">
      <div class="menu-list">
        <h2 class="menu-heading">Resolution Phase</h2>
        <h2 class="menu-heading">Question 1</h2>
        <ul class="button-list">
          <li class="button-list-item"><a class="pure-button" id="q1-next-btn" href="#">Next</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="screen" id="resolution-screen-2" state="inacive">
    <div class="main-content pure-u" id="planning-background">
      <div class="menu-list">
        <h2 class="menu-heading">Resolution Phase</h2>
        <h2 class="menu-heading">Question 2</h2>
        <ul class="button-list">
          <li class="button-list-item"><a class="pure-button" id="q2-next-btn" href="#">Next</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="screen" id="resolution-screen-3" state="inacive">
    <div class="main-content pure-u" id="planning-background">
      <div class="menu-list">
        <h2 class="menu-heading">Resolution Phase</h2>
        <h2 class="menu-heading">Question 3</h2>
        <ul class="button-list">
          <li class="button-list-item"><a class="pure-button" id="q3-next-btn" href="#">Next</a></li>
        </ul>
      </div>
    </div>
  </div>
</body>

<script>
Array.prototype.shuffle = function() {
    var input = this;

    for (var i = input.length-1; i >=0; i--) {

        var randomIndex = Math.floor(Math.random()*(i+1));
        var itemAtIndex = input[randomIndex];

        input[randomIndex] = input[i];
        input[i] = itemAtIndex;
    }
    return input;
};
  $(document).ready(function(){
    var gameStates = ['main-menu', 'warmup', 'planning',
      'resolution', 'paused', 'paused-help'];
      var RESOLUTION_QUESTIONS = 3;
    var game_paused = false;
    var round_ended = false;
    var currentGameState = 'main-menu';
    var totalPlayers = 1;
    var MAX_PLAYERS = 4;

    var PLANNING_TIME = 5;
    var BEEPING_TIME = 2;
    var LONG_BEEP_TIME = 10; // may change if audio file changes
    var WARMUP_TIME = 1;

    var warmup_flipclock;
    var planning_flipclock;
    var planningTimerA;
    var planningTimerB;
    var planningTimerAStart = false;
    var planningTimerBStart = false;
    var long_beep_playing = false;
    var waitingListCount = 0;
    var game_events;

    var music = new Howl({
      urls : ['res/snd/Mark - board game (looped).ogg'],
      autoplay : false,
      loop : true,
      volume : 0.5
    });

    var beep = new Howl({
      urls : ['res/snd/Beep-Shorter.ogg'],
      autoplay : false,
      loop : false,
      volume : 0.5
    });

    var long_beep = new Howl({
      urls : ['res/snd/Beep-Long.ogg'],
      autoplay : false,
      loop : false,
      volume : 0.5,
      onend : function(){
        console.log("Round over...");
      }
    });

    var music_playing = false;


    var chief_of_planning_events =  [
      {
          "desc": "Assign money to R&D projects.",
          "freq_min": 1,
          "freq_max": 3
      },
      {
          "desc": "Assign money to pay tenders - reduce cost by one step.",
          "freq_min": 3,
          "freq_max": 5
      }
    ];

    // base fig + round + prev round waiting list
    var chief_administrator_events = [
        {
            "desc": "Draw patient cards.",
            "freq_min": 3,
            "freq_max": 3
        }
    ];
    var chief_of_hr_events = [
        {
            "desc": 'Deal 3 doctor cards.',
            "freq_min": 2,
            "freq_max": 2
        }
    ];

    var round_events = [];

    // START GAME BUTTONS/WIDGETS
      $("#start-game").click(function(){
        if(currentGameState == "main-menu"){
          $("#menu-screen").attr("state", "inactive");
          $("#warmup-screen").attr("state", "active");
          warmup();
        } else {
          console.log("Wrong game state! " + currentGameState +
          " Supposed to be main-menu");
        }
      });

      $("#player-dec").click(function(){
        if(totalPlayers > 1){
          totalPlayers--;
          updatePlayerCount();
        };
      })
      $("#player-inc").click(function(){
        if(totalPlayers < MAX_PLAYERS){
          totalPlayers++;
          updatePlayerCount();
        };
      })

      // TODO: Assign roles
      function updatePlayerCount(){
        $("#playerCount").html(totalPlayers);
      }

      // GAME ROUND BUTTONS
      $("#end-game").click(function(){
        if(currentGameState != "main-menu"){

            if(game_paused){
              resumeGame();
            }
            // stop music
            if (music_playing){
              music.stop();
              music_playing = false;
            }
            // stop beep timers
            if(planningTimerAStart){
              planningTimerA.stop();
              planningTimerAStart = false;
            }
            if(planningTimerBStart){
              planningTimerB.stop()
              planningTimerBStart = false;
            }
            if (long_beep_playing){
              long_beep.stop();
              long_beep_playing = false;
            }

            // stop flipclock
            planning_flipclock.stop()

            $("#game-screen").attr("state", "inactive");
            $("#menu-screen").attr("state", "active");
            currentGameState = "main-menu";


        } else {
          console.log("Wrong game state! " + currentGameState +
          " Supposed to be not main menu");
        }
      });

      $("#toggle-music").click(function(){
        if(music_playing){
          music.stop();
          music_playing = false;
          console.log("Music paused.");
        } else {
          music.play();
          music_playing = true;
          console.log("Music un-paused.");
        }
      });
      function pauseGame(){
        // pause beep timers
        if(planningTimerAStart){
          planningTimerA.pause();
        }
        if(planningTimerBStart){
          planningTimerB.pause();
        }

        // pause main flipclock
        planning_flipclock.stop()

        // pause music if playing
        if(music_playing){
          music.pause();
        }

        // change paused label
        $("#pause-game").text("Resume Game");

        game_paused = true;
      }

      function resumeGame(){
        // resume beep timers
        if(planningTimerAStart){
          planningTimerA.start();
        }
        if(planningTimerBStart){
          planningTimerB.start();
        }

        // resume main clock
        planning_flipclock.start();

        // resume music if it was playing
        if(music_playing){
          music.play()
        }
        // change paused label
        $("#pause-game").text("Pause Game");
        game_paused = false;
      }
      $("#pause-game").click(function(){
        switch (game_paused) {
          case false:
            pauseGame();
            break;
          default:
            resumeGame();
        }
      })

      function warmup(){
        currentGameState = "warmup";
        warmup_flipclock = $("#warmup-flipclock").FlipClock(WARMUP_TIME, {
          clockFace : 'MinuteCounter',
          autostart : false,
          countdown: true,
          callbacks : {
            stop : startNewRound
        }});

        warmup_flipclock.start();

        console.log("Round started");
      }
      function generateEvents(){

          // TODO: double check actual random number checks - is it hitting
          // upper bound?

          var ch_o_hr_evs = [];
          console.log("Chief of HR events");
          for(var i = 0; i < chief_of_hr_events.length; i++){
            var ev = chief_of_hr_events[i];
            var count = ev.freq_min + Math.floor(Math.random() *
              (ev.freq_max - ev.freq_min));
            console.log("Adding " + ev.desc + " " + count + " times");
            for(var j = 0; j < count; j++){
              ch_o_hr_evs.push(ev.desc);
            }

          }
          console.log("Chief of Admin events" + chief_administrator_events.length);
          var ch_o_admin_evs = [];
          for(var i=0; i < chief_administrator_events.length; i++){
            var ev = chief_administrator_events[i];
            var count = ev.freq_min + Math.floor(Math.random() *
              (ev.freq_max - ev.freq_min));
            console.log("Adding " + ev.desc + " " + count + " times." );
            for(var j= 0; j < count; j++){
              ch_o_admin_evs.push(ev.desc);
            }
          }

          console.log("Chief of planning events" + chief_of_planning_events.length);
          var ch_o_pl_evs = [];
          for(var i = 0; i < chief_of_planning_events.length; i++){
            console.log("cop i" + i);
            var ev = chief_of_planning_events[i];
            var count = ev.freq_min + Math.floor(Math.random() *
              (ev.freq_max - ev.freq_min));
            console.log("Adding " + ev.desc + " " + count + " times." );
            for(var j = 0; j < count; j++){
              ch_o_pl_evs.push(ev.desc);
            }
          }

          var all_events = ch_o_hr_evs.concat(ch_o_admin_evs.concat(
            ch_o_pl_evs));
          return all_events.shuffle();
      }

      function startNewRound(){
        if(round_ended){
          $("#pause-game").show();
          round_ended = false;
        }
        if(currentGameState == "warmup"){
          currentGameState = "planning";
          console.log("Planning phase beginning!");
          $("#warmup-screen").attr("state", "inactive");
          $("#planning-screen").attr("state", "active");
          music.play();
          music_playing = true;

          planning_flipclock = $("#planning-flipclock").FlipClock(
            PLANNING_TIME,
         {
            clockFace : "MinuteCounter",
            autostart : false,
            countdown : true,
            callbacks : {
              stop : resolutionPhase
            }
          });

          // Beep timer
          planningTimerA = new Timer({
            onend : function(){
              planningTimerB = new Timer({
                ontick : function(){
                  beep.play();
                  $("#planning-background").css(
                    "background-color", "#f00");
                  setTimeout(function(){
                    $("#planning-background").css(
                      "background-color", "#7f7f7f");
                  }, 1);
                },
                onend : function(){
                  // pre-resolution-phase tasks
                  music.stop();
                  music_playing = false;
                  long_beep.play();
                  long_beep_playing = true;
                  round_ended = true;
                  $("#pause-game").hide();
                  $('#events-list').empty();
                }
              });
              planningTimerBStart = true;
              planningTimerB.start(BEEPING_TIME + 1);
            }
          });

          planningTimerA.start(PLANNING_TIME - BEEPING_TIME);
          planningTimerAStart = true;

          // Generate events!!
          game_events = generateEvents();
          prev_ev_id = null;
          var current_ev_i = 0;

          // TODO: fancy effects
          var event_dt = PLANNING_TIME / (game_events.length + 1);
          console.log("Event dt: " + event_dt);
          for(var i = 0; i < game_events.length; i++){
            console.log("Planning event: " + game_events[i]);
            //var ev = game_events[i];
            var tmp_ev_timer = new Timer({
              onend : function(){

                var ev = game_events.pop();
                console.log("New event! " + ev);
                var viewData = {event_data : ev, event_id : current_ev_i};
                current_ev_i++;
                $.Mustache.load('./html/event_block.html', viewData)
                  .done(function(){
                    $("#events-list").mustache('event-block', viewData,
                    { method: 'prepend' });
                  });
              }
            });
            tmp_ev_timer.start(Math.floor(i * event_dt));
          }
        } else {
          console.log("Wrong game state! " + currentGameState +
          " Supposed to be warmup");
        }
      }

      function resolutionPhase(){
        currentGameState = "resolution";
        $("#planning-screen").attr("state", "inactive");
        $("#resolution-screen-1").attr("state", "active");
      }
      $("#q1-next-btn").click(function(){
        $("#resolution-screen-1").attr("state", "inactive");
        $("#resolution-screen-2").attr("state", "active");
      })
      $("#q2-next-btn").click(function(){
        $("#resolution-screen-2").attr("state", "inactive");
        $("#resolution-screen-3").attr("state", "active");
      })
      $("#q3-next-btn").click(function(){
        $("#resolution-screen-3").attr("state", "inactive");
        $("#warmup-screen").attr("state", "active");
        warmup();
      })
      /*for(var i = 0; i < RESOLUTION_QUESTIONS; i++){
        $("#q"+(i+1)+"-next-btn").click(function(){
          $("#resolution-screen-"+(i+1)).attr("state", "inactive");
          if(i+1 < RESOLUTION_QUESTIONS){
            $("#resolution-screen-"+(i+2)).attr("state", "active");
          }
          else {
              // get answers to questions
          }
        })
      }*/
  });
  </script>
</html>
