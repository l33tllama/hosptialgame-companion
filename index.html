<!doctype html>
<html>
<head>
  <title>Hospital Game Companion App</title>
  <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <link rel="stylesheet" href="bower_components/flipclock/src/flipclock/css/flipclock.css"/>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/flipclock/compiled/flipclock.min.js"></script>
  <script src="bower_components/howler.js/howler.min.js"></script>
  <script src="bower_components/jquery-Mustache/jquery.mustache.js"></script>
  <script src="bower_components/mustache.js/mustache.min.js"></script>
  <script src="bower_components/timer.js/dist/timer.min.js"></script>
</head>
<body>
  <div class="header">
    <h1><img id="logo" src="/res/img/lemmling-walrus.svg"/>
    Knotwurst Hospital Companion App</h1>
  </div>

  <!-- MENU SCREEN -->
  <div class="screen" id="menu-screen" state="active">
    <div class="main-content pure-u">
      <div class="menu-list">
        <ul class="button-list">
          <li class="button-list-item-custom">
            <span class="button-list-label">Number of Players:</span>
          </li>
          <li class="button-list-item-segmented pure-g">
            <span class="pure-u-1-3 button-1-3-wrapper">
              <a class="pure-button" id="player-dec">-</a>
            </span>
            <span class="pure-u-1-3 button-list-label" id="playerCount">1</span>
            <span class="pure-u-1-3 button-1-3-wrapper">
              <a class="pure-button pure-u-1-3" id="player-inc">+</a>
            </span>
            </li>
          <li class="button-list-item"><a class="pure-button" id="start-game" href="#">Start Game</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- WARMUP SCREEN -->
  <div class="screen" id="warmup-screen" state="inactive">
    <div class="main-content">
      <div class="menu-list">
        <div class="warmup-container pure-u">
          <h2 class="menu-heading">Warmup..</h2>
          <span class="pure-u-1-3"></span>
          <div class="flipclock pure-u-1-3"  id="warmup-flipclock"></div>
          <span class="pure-u-1-3"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- PLANNING PHASE SCREEN -->
  <div class="screen" id="planning-screen" state="inacive">
    <div class="main-content pure-u" id="planning-background">
      <div class="menu-list">
        <h2 class="menu-heading">Planning Phase</h2>
        <div class="clock-container pure-u">
          <span class="pure-u-1-3"></span>
          <div class="flipclock pure-u-1-3"  id="planning-flipclock"></div>
          <span class="pure-u-1-3"></span>
        </div>
        <ul class="button-list">
          <div class="event-list-container-container pure-g">
            <span class="pure-u-1-12"></span>
            <div class="pure-u-20-24 button-list-item-event-container" id="events-list">
            </div>
            <span class="pure-u-1-12"></span>
          </div>
          <ul class="button-list">
            <li class="button-list-item"><a class="pure-button" id="toggle-music" href="#">Toggle Music</a></li>
            <li class="button-list-item"><a class="pure-button" id="pause-game" href="#">Pause Game</a></li>
            <li class="button-list-item"><a class="pure-button" id="end-game" href="#">End Game</a></li>
          </ul>
        </ul>
      </div>
    </div>
  </div>
</body>

<script>
  $(document).ready(function(){
    var gameStates = ['main-menu', 'warmup', 'planning',
      'resolution', 'paused', 'paused-help'];
    var game_paused = false;
    var currentGameState = 'main-menu';
    var totalPlayers = 1;
    var MAX_PLAYERS = 4;

    var PLANNING_TIME = 13;
    var BEEPING_TIME = 12;
    var LONG_BEEP_TIME = 10; // may change if audio file changes
    var WARMUP_TIME = 1;

    var warmup_flipclock;
    var planning_flipclock;
    var planningTimerA;
    var planningTimerB;
    var planningTimerAStart = false;
    var planningTimerBStart = false;
    var long_beep_playing = false;

    var music = new Howl({
      urls : ['res/snd/Mark - board game (looped).ogg'],
      autoplay : false,
      loop : true,
      volume : 0.5
    });

    var beep = new Howl({
      urls : ['res/snd/Beep-Shorter.ogg'],
      autoplay : false,
      loop : false,
      volume : 0.5
    });

    var long_beep = new Howl({
      urls : ['res/snd/Beep-Long.ogg'],
      autoplay : false,
      loop : false,
      volume : 0.5,
      onend : function(){
        console.log("Round over...");
      }
    });

    var music_playing = false;

    var player_events = {
      chief_of_planning : { "draw_3_facilities" : {
        desc : "Draw 3 facilities tiles, 1 at a time (yes, you can look at them!), from\
         the face-down facilities pile. These are now available to purchase \
         under tender."
      },
      "pay_tenders" : {
        desc : "Assign money to pay for tenders (at point-in-time - prices reduce as \
          time progresses, see app for actual price and to ensure itâ€™s still \
          available)",
      }
    },
      chief_administrator : [],
      chief_of_medical_staff : [],
      chief_of_hr : []
    };

    var current_events = {
      chief_of_planning : [],
      chief_administrator : [],
      chief_of_medical_staff : [],
      chief_of_hr : []
    };

    // START GAME BUTTONS/WIDGETS
      $("#start-game").click(function(){
        if(currentGameState == "main-menu"){
          $("#menu-screen").attr("state", "inactive");
          $("#warmup-screen").attr("state", "active");
          warmup();
        } else {
          console.log("Wrong game state! " + currentGameState +
          " Supposed to be main-menu");
        }
      });

      $("#player-dec").click(function(){
        if(totalPlayers > 1){
          totalPlayers--;
          updatePlayerCount();
        };
      })
      $("#player-inc").click(function(){
        if(totalPlayers < MAX_PLAYERS){
          totalPlayers++;
          updatePlayerCount();
        };
      })

      // TODO: Assign roles
      function updatePlayerCount(){
        $("#playerCount").html(totalPlayers);
      }

      // GAME ROUND BUTTONS
      $("#end-game").click(function(){
        if(currentGameState != "main-menu"){

            if(game_paused){
              resumeGame();
            }
            // stop music
            if (music_playing){
              music.stop();
              music_playing = false;
            }
            // stop beep timers
            if(planningTimerAStart){
              planningTimerA.stop();
              planningTimerAStart = false;
            }
            if(planningTimerBStart){
              planningTimerB.stop()
              planningTimerBStart = false;
            }
            if (long_beep_playing){
              long_beep.stop();
              long_beep_playing = false;
            }

            // stop flipclock
            planning_flipclock.stop()

            $("#game-screen").attr("state", "inactive");
            $("#menu-screen").attr("state", "active");
            currentGameState = "main-menu";


        } else {
          console.log("Wrong game state! " + currentGameState +
          " Supposed to be not main menu");
        }
      });

      $("#toggle-music").click(function(){
        if(music_playing){
          music.stop();
          music_playing = false;
          console.log("Music paused.");
        } else {
          music.play();
          music_playing = true;
          console.log("Music un-paused.");
        }
      });
      function pauseGame(){
        // pause beep timers
        if(planningTimerAStart){
          planningTimerA.pause();
        }
        if(planningTimerBStart){
          planningTimerB.pause();
        }

        // pause main flipclock
        planning_flipclock.stop()

        // pause music if playing
        if(music_playing){
          music.pause();
        }

        // change paused label
        $("#pause-game").text("Resume Game");

        game_paused = true;
      }

      function resumeGame(){
        // resume beep timers
        if(planningTimerAStart){
          planningTimerA.start();
        }
        if(planningTimerBStart){
          planningTimerB.start();
        }

        // resume main clock
        planning_flipclock.start();

        // resume music if it was playing
        if(music_playing){
          music.play()
        }
        // change paused label
        $("#pause-game").text("Pause Game");
        game_paused = false;
      }
      $("#pause-game").click(function(){
        switch (game_paused) {
          case false:
            pauseGame();
            break;
          default:
            resumeGame();
        }
      })

      function warmup(){
        currentGameState = "warmup";
        warmup_flipclock = $("#warmup-flipclock").FlipClock(WARMUP_TIME, {
          clockFace : 'MinuteCounter',
          autostart : false,
          countdown: true,
          callbacks : {
            stop : startNewRound
        }});

        warmup_flipclock.start();

        console.log("Round started");
      }

      function startNewRound(){
        if(currentGameState == "warmup"){
          currentGameState = "planning";
          console.log("Planning phase beginning!");
          $("#warmup-screen").attr("state", "inactive");
          $("#planning-screen").attr("state", "active");
          music.play();
          music_playing = true;

          planning_flipclock = $("#planning-flipclock").FlipClock(PLANNING_TIME,
         {
            clockFace : "MinuteCounter",
            autostart : false,
            countdown : true,
            callbacks : {
              stop : roundTimeout
            }
          });

          planningTimerA = new Timer({
            onend : function(){
              planningTimerB = new Timer({
                ontick : function(){
                  beep.play();
                  $("#planning-background").css("background-color", "#f00");
                  setTimeout(function(){
                    $("#planning-background").css("background-color", "#7f7f7f");
                  }, 1);
                },
                onend : function(){
                  music.stop();
                  music_playing = false;
                  long_beep.play();
                  long_beep_playing = true;
                }
              });
              planningTimerBStart = true;
              planningTimerB.start(BEEPING_TIME + 1);
            }
          });

          planningTimerA.start(PLANNING_TIME - BEEPING_TIME);
          planningTimerAStart = true;


          var viewData = { event_data: 'game event', event_id : 1 };
          $.Mustache.load('./html/event_block.html')
              .done(function () {
                  $('#events-list').mustache('event-block', viewData);
          });

        } else {
          console.log("Wrong game state! " + currentGameState +
          " Supposed to be warmup");
        }
      }

      function roundTimeout(){

      }
  });
  // YEAR -
  // start a round
  // decision phase - timed
  // resolution phase - checklist to make sure everything went right
  </script>
</html>
